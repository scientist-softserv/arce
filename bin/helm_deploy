#!/bin/bash

if [ -z "$1" ] || [ -z "$2" ]
then
    echo './bin/helm_deploy RELEASE_NAME NAMESPACE'
    exit 1
fi
release_name="${1}"
namespace="${2}"

DEPLOY_IMAGE="${DEPLOY_IMAGE:-ghcr.io/scientist-softserv/arce}"
SOLR_IMAGE="${SOLR_IMAGE:-ghcr.io/scientist-softserv/arce/solr}"
DEPLOY_TAG="${DEPLOY_TAG:-latest}"

# Extracting the environment value after "-"
environment=${release_name#*-}
deploy_file="${environment}-deploy"

ENV_FILE="./.env.${environment}"
ENCRYPTED_ENV_FILE="./.env.${environment}.enc"
DECRYPTED_ENV_FILE="./.env.${environment}.dec"

# FOR LOCAL DEPLOY SET DEPLOY TAG
# run ./bin/helm_deploy RELEASE_NAME NAMESPACE
# If we are deploying locally we will have the
# .env.${environment} file, get this from 1Password
if [ -f "$ENV_FILE" ]; then
  # remove our previous tests
  rm -rf "./.env.${environment}.enc"
  rm -rf "./.env.${environment}.dec"
  rm -rf "ops/${deploy_file}.yaml"

  # set our env file for use with the deploy
  cat "$ENV_FILE" | base64 > "$ENCRYPTED_ENV_FILE"
  cat "$ENCRYPTED_ENV_FILE" | base64 -d > "$DECRYPTED_ENV_FILE"

  # set the values file
  HELM_EXTRA_ARGS="--values ops/${deploy_file}.yaml"
  # DEPLOY_TAG= <-------- DONT FORGET TO SET ME
fi

# FOR GitHub ACTIONS DEPLOY SET ENCRYPTED_ENV_FILE in
# GitHub Environment Secret section of project repo after
# copying the .env.${environment} file to your project
# you can then get the ENCRYPTED_ENV_FILE value with a
# cat "$ENV_FILE" | base64 > "$ENCRYPTED_ENV_FILE"
# in your terminal locally to set in GitHub
echo "$ENCRYPTED_ENV_FILE" | base64 -d > "$DECRYPTED_ENV_FILE"

# Take the env file and export each key value pair
# so we can use it with envsubst in our deploy
# without this we would not be able to work
while IFS='=' read -r key value; do
  export "$key=${value//\"/}"
done < <(grep -v '^#' "$DECRYPTED_ENV_FILE")

DOLLAR=$ envsubst <"ops/${deploy_file}.tmpl.yaml" >"ops/${deploy_file}.yaml"

helm upgrade \
    --install \
    --atomic \
    --timeout 15m0s \
    --set rails.image.repository="$DEPLOY_IMAGE" \
    --set rails.image.tag="$DEPLOY_TAG" \
    --set solr.image.repository="$SOLR_IMAGE" \
    --set solr.image.tag="$DEPLOY_TAG" \
    $HELM_EXTRA_ARGS \
    --namespace="$namespace" \
    --create-namespace \
    "$release_name" \
    chart
